<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="generator" content="Hugo 0.56.3" />
    
    
        <title>Java反射机制学习笔记 - root@v</title>
    
    
    <meta itemprop="name" content="Java反射机制学习笔记">
<meta itemprop="description" content="Java反射机制">


<meta itemprop="datePublished" content="2018-07-25T16:40:20&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-25T16:40:20&#43;08:00" />
<meta itemprop="wordCount" content="4320">



<meta itemprop="keywords" content="Java," />

    <meta property="og:title" content="Java反射机制学习笔记" />
<meta property="og:description" content="Java反射机制" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vorblock.cc/post/java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />

<meta property="og:image" content="https://vorblock.cc/favicon.svg" />

<meta property="og:image" content="https://my-md-1253484710.cos.ap-chengdu.myqcloud.com/tx.jpg" />
<meta property="article:published_time" content="2018-07-25T16:40:20+08:00" />
<meta property="article:modified_time" content="2018-07-25T16:40:20+08:00" />

    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://vorblock.cc/favicon.svg"/>

<meta name="twitter:title" content="Java反射机制学习笔记"/>
<meta name="twitter:description" content="Java反射机制"/>

    

    
    
    

    
    
    <meta property="description" content="Java反射机制">
    
    

    

    <link rel="canonical" href="https://vorblock.cc/post/java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
    <link rel="shortcut icon" href="/favicon.png">


    
    
    <style media="screen">
            html{font-size:100%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}body{margin:0;padding:0;background:#2a363b;color:#c6c6c7}button,input,select,textarea,label{margin:0;padding:0;font-family:inherit;font-size:inherit}img{max-width:100%}body{line-height:1.75}h1,h2,h3,h4,h5,h6{padding:0;line-height:1.25;text-align:center}h1{font-size:32px;font-weight:400}h2{font-size:22px;font-weight:700}h3,h4,h5,h6{font-size:19px;font-weight:700;text-align:left}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #ddd;font-style:oblique;background:#355c7d}pre,code{font-size:.9em}pre code{display:block;border:1px solid #ddd;padding:1em;overflow-x:auto;line-height:1.75}code{padding:.1rem .2rem;background:#99b898;color:#282c34}.vglnk{color:#282c34}pre code{background:#dbebc2}ul,ol{padding:0 0 0 20px}li{margin:4px 0;padding:0}a{color:#c6c6c7;text-decoration:none;padding-bottom:2px;border-bottom:1px solid}sup a{border-bottom:none}hr{display:block;height:1px;border:0;border-top:1px solid;margin:50px auto;padding:0;max-width:300px}.copyright{text-align:center}.post-nav{display:flex;justify-content:space-between;font-weight:700}.nav-next{margin-left:1em;text-align:right}.nav-prev{margin-right:1em}.comments{margin-top:20px}body{width:960px;margin:0 auto;padding:30px 0}.masthead{width:260px;padding:20px 50px 20px 10px;float:left}.main{width:700px;padding:32px 10px 20px 50px;margin-left:260px;border-left:3px solid #000;min-height:calc(100vh - 60px)}.masthead h1{margin-top:0;margin-bottom:34px;padding:0;text-align:right;font-size:46px;line-height:58px}.masthead h1 a{border-bottom:none}.masthead .tagline{font-style:italic;text-align:right}.masthead .menu{margin-right:20px;direction:rtl}.masthead .menu a{direction:ltr}.masthead .menu ul ul{list-style:none;margin-left:10px;margin-right:10px}.masthead .menu li li::before{content:"•\00a\000a0\00a0"}.title h3.post-meta{font-family:lucida console,andale mono,stkaiti,kaiti,simkai,monospace;text-align:right;margin:0 0 20px}.title h3.post-meta .tags a{font-size:.8em}.title h3.post-meta .category a{font-size:.9em}#menu-check{display:none}#menu-label{display:none}.main .title h1{margin-top:0;margin-bottom:40px}.title h3{font-weight:400;text-align:center}.subtitle{font-size:.9em;color:#666}.footnotes{font-size:.9em}table{margin:auto;border-top:1px solid #666;border-bottom:1px solid #666}table thead th{border-bottom:1px solid #666}th,td{padding:5px}thead,tfoot,tr:nth-child(even){background:#f8f8f8}.toc{margin-top:100px}.unselectable{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}@-ms-viewport{width:device-width;}@viewport{width:device-width;}@media screen and (max-width:960px){body{width:auto;max-width:700px}.masthead{width:auto;float:none;text-align:center;margin-left:10px;margin-right:10px;padding:10px 10px 45px;border-bottom:3px solid #000}.main{width:auto;padding:20px 10px;margin-left:0;border-left:none;min-height:auto}.masthead h1{text-align:left;font-size:30px;margin-bottom:0;line-height:40px}.masthead .tagline{text-align:left;margin:0}.masthead .menu{direction:ltr;max-width:300px;margin-left:auto;margin-right:auto}.masthead #menu-label{position:absolute;top:30px;right:0}.masthead .menu ul{text-align:left;margin:0;padding:0;float:none}.masthead .menu ul ul{margin:0}.masthead .menu li{border-bottom:1px solid;list-style:none;margin:0;padding:0}.masthead .menu li:first-child{border-top:1px solid}.masthead .menu li li:last-child{border-bottom:none}.masthead .menu a{display:block;padding:15px 20px;border-bottom:none}.masthead .menu li li a{padding-left:30px}.masthead .menu li li::before{content:none}.masthead .menu li li a::before{content:"•\00a0\00a0\00a0"}#menu-label{display:inline-block;padding:0 20px;height:50px;cursor:pointer;line-height:50px;color:#fff5f5;font-size:20px;margin-top:10px}#menu-check~label .close-icon{display:none}#menu-check~label .open-icon{display:inline-block}#menu-check:checked~label .close-icon{display:inline-block}#menu-check:checked~label .open-icon{display:none}#menu-check~ul{display:none}#menu-check:checked~ul{display:block;margin-top:50px;margin-bottom:0}}@media screen and (max-width:720px){}@media screen and (max-width:480px){body{font-size:16px}h1{font-size:28px}h2{font-size:18px}h3,h4,h5,h6{font-size:16px}pre,code{font-size:12px}.masthead{padding-top:0}}body{font-family:Optima,lucida sans,Calibri,Candara,Arial,source-han-serif-sc,source han serif sc,source han serif cn,source han serif tc,source han serif tw,source han serif,songti sc,microsoft yahei,sans-serif}code{font-family:lucida console,andale mono,stkaiti,kaiti,simkai,monospace}pre code{font-family:Consolas,lucida console,Monaco,stkaiti,kaiti,simkai,monospace}.chroma{background-color:#f8f8f8}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:#ce5c00}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:#4e9a06}.chroma .sa{color:#4e9a06}.chroma .sb{color:#4e9a06}.chroma .sc{color:#4e9a06}.chroma .dl{color:#4e9a06}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:#4e9a06}.chroma .se{color:#4e9a06}.chroma .sh{color:#4e9a06}.chroma .si{color:#4e9a06}.chroma .sx{color:#4e9a06}.chroma .sr{color:#4e9a06}.chroma .s1{color:#4e9a06}.chroma .ss{color:#4e9a06}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:#ce5c00;font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}div#isso-thread .avatar>svg[data-hash=a0d752802ad5]{box-shadow:0 0 12px #b80f28;border-radius:50%}div#isso-thread a{border-bottom:none}
        </style>
        
    
    
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140385231-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'UA-140385231-1');
        </script>
        
        
    

</head>



<body class="post">
    <header class="masthead">
        <div class="header">
            <h1><a href="/">root@v</a></h1>
            
            <p class="tagline">Are You OK?</p>
            
        </div>
        
        <nav class="menu">
            <input id="menu-check" type="checkbox" />
            <label id="menu-label" for="menu-check" class="unselectable">
                <span class="icon close-icon">✕</span>
                <span class="icon open-icon">☰</span>
                <span class="text">MENU</span>
            </label>
            <ul>
                
                    
                    <li>
                        <a href="/post/">/POSTS/~</a>
                    </li>
                
                    <li>
                        <a href="/todo/">/TODO/~</a>
                    </li>
                
                    <li>
                        <a href="/categories/">/CATEGORIES/~</a>
                    </li>
                
                    <li>
                        <a href="/tags/">/TAGS/~</a>
                    </li>
                
                    <li>
                        <a href="/about/">/ABOUT/~</a>
                    </li>
                
                    <li>
                        <a href="/reading/">/Reading/~</a>
                    </li>
                
                    <li>
                        <a href="/index.xml">/RSS</a>
                    </li>
                
            </ul>
            
        </nav>
        
    </header>

    <article class="main">
        <header class="title">
            
<h3 class="post-meta">
    
    <span itemprop="articleSection" class="category">
        
        <a href="/categories/Java" rel="category">Java</a>
        
        <a href="/categories/%e7%ac%94%e8%ae%b0" rel="category">笔记</a>
        
    </span>
    /
    
    
    <span itemprop="keywords" class="tags">
        
        <a href="/tags/Java" rel="tag">Java</a>
        
    </span>
    
</h3>


<h1>Java反射机制学习笔记</h1>

<h3>
    
    vorblock
    
      /  2018-07-25
</h3>

<hr>

        </header>
        <div class="container">
            

    
    
    

    
    
    

    

<h2 id="java-反射机制学习记录">Java 反射机制学习记录</h2>

<p>在逆向中反射也是能经常看见，之前理解不是很深透，现在来重点学习一下，做个笔记。</p>

<h3 id="什么是反射机制">什么是反射机制？</h3>

<p>反射(Reflection)是Java 程序开发语言的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。 通俗一点：在动态运行时，获取到一个类的所有方法以及成员。简而言之，通过反射，我们可以在<strong>运行时</strong>获得程序或程序集中每一个类型的成员和成员的信息。</p>

<h3 id="作用">作用？</h3>

<ul>
<li>1.在运行时判断任意一个对象所属的类；</li>
<li>2.在运行时构造任意一个类的对象；</li>
<li>3.在运行时判断任意一个类所具有的成员变量和方法（通过反射甚至可以调用private方法）；</li>
<li>4.在运行时调用任意一个对象的方法</li>
</ul>

<h5 id="是运行时而不是编译时"><strong>是运行时而不是编译时</strong></h5>

<ul>
<li>获取某些类的一些变量，调用某些类的私有方法。</li>
<li>增加代码的灵活性。很多主流框架都使用了反射技术.像ssh框架都采用两种技术 xml做配置文件+反射技术.</li>
</ul>

<h3 id="基本使用">基本使用</h3>

<p>反射相关的类一般都在java.lang.relfect 包里。</p>

<ol>
<li>获取Class对象 3种方法</li>
</ol>

<p>(1)使用Class类的forName静态方法:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span><span class="p">(</span><span class="n">String</span> <span class="nf">className</span><span class="p">)</span>
   <span class="c1">//在JDBC开发中常用此方法加载数据库驱动:
</span><span class="c1"></span>   <span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span></code></pre></div>
<p>(2)直接获取某一个对象的class，比如:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">classInt</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">TYPE</span><span class="p">;</span></code></pre></div>
<p>(3)调用某个对象的getClass()方法,比如:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="n">StringBuilder</span> <span class="nf">str</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="s">&#34;123&#34;</span><span class="p">);</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span></code></pre></div>
<ol>
<li>判断是否为某一个类的实例</li>
</ol>

<p>一般使用instanceof来判断，也可以借助反射中的Class对象的isInstance()方法来判断  是一个Native方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">native</span> <span class="kt">boolean</span> <span class="nf">isInstance</span><span class="p">(</span><span class="n">Object</span> <span class="nf">obj</span><span class="p">);</span></code></pre></div>
<ol>
<li>创建实例</li>
</ol>

<p>通过放射来生成对象两种方式：</p>

<p>（1）使用Class对象的newInstance()方法来创建Class对象对应类的实例。</p>

<pre><code>   Class&lt;?&gt; c = String.class;
   Object str = c.newInstance();
</code></pre>

<p>（2）先通过Class对象获取指定的Constructor对象，再调用Constructor对象的newInstance()方法来创建实例。这种方法可以用指定的构造器构造类的实例。</p>

<pre><code>   //获取String所对应的Class对象
   Class&lt;?&gt; c = String.class;
   //获取String类带一个String参数的构造器
   Constructor constructor = c.getConstructor(String.class);
   //根据构造器创建实例
   Object obj = constructor.newInstance(&quot;23333&quot;);
   System.out.println(obj);
</code></pre>

<ol>
<li>获取方法</li>
</ol>

<p>getDeclaredMethods()方法返回类或接口声明的所有方法，包括公共、保护、默认（包）访问和私有方法，但不包括继承的方法。</p>

<pre><code>   public Method[] getDeclaredMethods() throws SecurityException
</code></pre>

<p>getMethods()方法返回某个类的所有公用（public）方法，包括其继承类的公用方法。</p>

<pre><code>   public Method[] getMethods() throws SecurityException
</code></pre>

<p>getMethod方法返回一个特定的方法，其中第一个参数为方法名称，后面的参数为方法的参数对应Class的对象</p>

<pre><code>   public Method getMethod(String name, Class&lt;?&gt;... parameterTypes)
</code></pre>

<p>eg:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nf">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">InvocationTargetException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nf">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Method</span><span class="p">;</span>


<span class="kd">public</span> <span class="nf">class</span> <span class="n">test</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">IllegalAccessException</span><span class="p">,</span> <span class="n">InstantiationException</span><span class="p">,</span>
            <span class="n">NoSuchMethodException</span><span class="p">,</span> <span class="n">InvocationTargetException</span> <span class="p">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">methodClass</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
        <span class="n">Object</span> <span class="nf">object</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span>
        <span class="n">Method</span><span class="p">[]</span> <span class="nf">methods</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="na">getMethods</span><span class="p">();</span>
        <span class="n">Method</span><span class="p">[]</span> <span class="nf">declaredMethods</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="na">getDeclaredMethods</span><span class="p">();</span>
        <span class="n">Method</span> <span class="nf">method</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;add&#34;</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">//获取add方法
</span><span class="c1"></span>        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;getMethods获取的方法：&#34;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Method</span> <span class="nf">m</span> <span class="o">:</span> <span class="n">methods</span><span class="p">)</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;getDeclaredMethods获取的方法：&#34;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Method</span> <span class="nf">m</span> <span class="o">:</span> <span class="n">declaredMethods</span><span class="p">)</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="nf">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="n">test1</span><span class="p">();</span>

        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">){</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nf">methodClass</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">final</span> <span class="kt">int</span> <span class="nf">fuck</span> <span class="o">=</span> <span class="n">3</span><span class="p">;</span>
    <span class="kd">public</span> <span class="nf">int</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="nf">a</span><span class="p">,</span><span class="kt">int</span> <span class="nf">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="nf">int</span> <span class="n">sub</span><span class="p">(</span><span class="kt">int</span> <span class="nf">a</span><span class="p">,</span><span class="kt">int</span> <span class="nf">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180725151348.png" alt="" /></p>

<ol>
<li>获取构造器信息</li>
</ol>

<p>通过Class类的getConstructor方法得到Constructor类的一个实例，而Constructor类有一个newInstance方法可以创建一个对象实例:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">T</span> <span class="n">newInstance</span><span class="p">(</span><span class="n">Object</span> <span class="p">...</span> <span class="n">initargs</span><span class="p">)</span></code></pre></div>
<ol>
<li>获取类的成员字段信息</li>
</ol>

<p><code>getFiled</code>: 访问公有的成员变量</p>

<p><code>getDeclaredField</code>：所有已声明的成员变量。但不能得到其父类的成员变量</p>

<p><code>getFileds</code>和<code>getDeclaredFields</code>用法同上（参照Method）</p>

<ol>
<li>调用方法</li>
</ol>

<p>获取到方法后使用invoke()方法来调用这个方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">Object</span> <span class="n">invoke</span><span class="p">(</span><span class="n">Object</span> <span class="nf">obj</span><span class="p">,</span> <span class="n">Object</span><span class="p">...</span> <span class="nf">args</span><span class="p">)</span>
           <span class="kd">throws</span> <span class="nf">IllegalAccessException</span><span class="p">,</span> <span class="n">IllegalArgumentException</span><span class="p">,</span>
              <span class="n">InvocationTargetException</span></code></pre></div>
<p>eg：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">class</span> <span class="n">test1</span> <span class="p">{</span>
   
       <span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="nf">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="nf">IllegalAccessException</span><span class="p">,</span> <span class="n">InstantiationException</span><span class="p">,</span> <span class="n">NoSuchMethodException</span><span class="p">,</span> <span class="n">InvocationTargetException</span> <span class="p">{</span>
           <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">methodClass</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
           <span class="c1">//创建methodClass的实例
</span><span class="c1"></span>           <span class="n">Object</span> <span class="nf">obj</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span>
           <span class="c1">//获取methodClass类的add方法
</span><span class="c1"></span>           <span class="n">Method</span> <span class="nf">method</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;add&#34;</span><span class="p">,</span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
           <span class="c1">//调用method对应的方法 =&gt; add(1,4)
</span><span class="c1"></span>           <span class="n">Object</span> <span class="nf">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">);</span>
           <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
       <span class="p">}</span>
   
   <span class="p">}</span>
   
   <span class="kd">class</span> <span class="nf">methodClass</span> <span class="p">{</span>
   
       <span class="kd">public</span> <span class="nf">final</span> <span class="kt">int</span> <span class="nf">fuck</span> <span class="o">=</span> <span class="n">3</span><span class="p">;</span>
       <span class="kd">public</span> <span class="nf">int</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="nf">a</span><span class="p">,</span><span class="kt">int</span> <span class="nf">b</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="kd">public</span> <span class="nf">int</span> <span class="n">sub</span><span class="p">(</span><span class="kt">int</span> <span class="nf">a</span><span class="p">,</span><span class="kt">int</span> <span class="nf">b</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span></code></pre></div>
<ol>
<li><p>创建数组</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">testArray</span><span class="p">()</span> <span class="kd">throws</span> <span class="nf">ClassNotFoundException</span> <span class="p">{</span>
       <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="p">);</span>
       <span class="n">Object</span> <span class="nf">array</span> <span class="o">=</span> <span class="n">Array</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">25</span><span class="p">);</span> <span class="c1">//通过Array.newInstance()
</span><span class="c1"></span>       <span class="c1">//往数组里添加内容
</span><span class="c1"></span>       <span class="n">Array</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="s">&#34;hello&#34;</span><span class="p">);</span>  <span class="c1">//Array类为java.lang.reflect.Array
</span><span class="c1"></span>       <span class="n">Array</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="s">&#34;Java&#34;</span><span class="p">);</span>
       <span class="n">Array</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="s">&#34;fuck&#34;</span><span class="p">);</span>
       <span class="n">Array</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">3</span><span class="p">,</span><span class="s">&#34;Scala&#34;</span><span class="p">);</span>
       <span class="n">Array</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="s">&#34;Clojure&#34;</span><span class="p">);</span>
       <span class="c1">//获取某一项的内容
</span><span class="c1"></span>       <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Array</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">3</span><span class="p">));</span>
   <span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="n">Object</span> <span class="nf">newInstance</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">length</span><span class="p">)</span>
       <span class="kd">throws</span> <span class="nf">NegativeArraySizeException</span> <span class="p">{</span>
       <span class="k">return</span> <span class="n">newArray</span><span class="p">(</span><span class="n">componentType</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
   <span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nf">static</span> <span class="kd">native</span> <span class="nf">Object</span> <span class="n">newArray</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">length</span><span class="p">)</span>
       <span class="kd">throws</span> <span class="nf">NegativeArraySizeException</span><span class="p">;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">arrayOop</span> <span class="n">Reflection</span><span class="o">::</span><span class="n">reflect_new_array</span><span class="p">(</span><span class="n">oop</span> <span class="n">element_mirror</span><span class="p">,</span> <span class="n">jint</span> <span class="n">length</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">element_mirror</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_NullPointerException</span><span class="p">());</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_NegativeArraySizeException</span><span class="p">());</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Class</span><span class="o">::</span><span class="n">is_primitive</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">))</span> <span class="p">{</span>
   <span class="n">Klass</span><span class="o">*</span> <span class="n">tak</span> <span class="o">=</span> <span class="n">basic_type_mirror_to_arrayklass</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">,</span> <span class="n">CHECK_NULL</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">TypeArrayKlass</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="n">tak</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="n">Klass</span><span class="o">*</span> <span class="n">k</span> <span class="o">=</span> <span class="n">java_lang_Class</span><span class="o">::</span><span class="n">as_Klass</span><span class="p">(</span><span class="n">element_mirror</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">oop_is_array</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ArrayKlass</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dimension</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">MAX_DIM</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_IllegalArgumentException</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">oopFactory</span><span class="o">::</span><span class="n">new_objArray</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
</ol>

<p>Array类的set()和get()方法都为Native方法，在HotSpot JVM里分别对应Reflection::array_set和Reflection::array_get方法</p>

<ol>
<li><p>获取泛型</p>

<p>getGenericHelper(HashMap<String, Person> map)</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span>  <span class="kt">void</span> <span class="nf">getGenericType</span><span class="p">()</span> <span class="p">{</span>
       <span class="k">try</span> <span class="p">{</span>
           <span class="n">Method</span> <span class="nf">method</span> <span class="o">=</span><span class="n">TestHelper</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getGenericHelper&#34;</span><span class="p">,</span><span class="n">HashMap</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
           <span class="n">Type</span><span class="p">[]</span> <span class="nf">genericParameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="na">getGenericParameterTypes</span><span class="p">();</span>
           <span class="c1">// 检验是否为空
</span><span class="c1"></span>           <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">genericParameterTypes</span> <span class="o">||</span> <span class="n">genericParameterTypes</span><span class="p">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">1</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">return</span> <span class="p">;</span>
           <span class="p">}</span>
           <span class="c1">// 取 getGenericHelper 方法的第一个参数
</span><span class="c1"></span>   
           <span class="n">ParameterizedType</span> <span class="nf">parameterizedType</span><span class="o">=</span><span class="p">(</span><span class="n">ParameterizedType</span><span class="p">)</span><span class="n">genericParameterTypes</span><span class="p">[</span><span class="n">0</span><span class="p">];</span>
           <span class="n">Type</span> <span class="nf">rawType</span> <span class="o">=</span> <span class="n">parameterizedType</span><span class="p">.</span><span class="na">getRawType</span><span class="p">();</span>
           <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;----&gt; rawType=&#34;</span> <span class="o">+</span> <span class="n">rawType</span><span class="p">);</span>
           <span class="n">Type</span><span class="p">[]</span> <span class="nf">actualTypeArguments</span> <span class="o">=</span> <span class="n">parameterizedType</span><span class="p">.</span><span class="na">getActualTypeArguments</span><span class="p">();</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">actualTypeArguments</span><span class="o">==</span><span class="n">genericParameterTypes</span> <span class="o">||</span> <span class="n">actualTypeArguments</span><span class="p">.</span><span class="na">length</span><span class="o">&lt;</span><span class="n">1</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">return</span> <span class="p">;</span>
           <span class="p">}</span>
           <span class="c1">//  打印出每一个类型          
</span><span class="c1"></span>           <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="n">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">actualTypeArguments</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">Type</span> <span class="nf">type</span> <span class="o">=</span> <span class="n">actualTypeArguments</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
               <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;----&gt; type=&#34;</span> <span class="o">+</span> <span class="n">type</span><span class="p">);</span>
           <span class="p">}</span>
       <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
   
       <span class="p">}</span>
   
   <span class="p">}</span></code></pre></div>
<ol>
<li><p>获得 Metho,Field,Constructor 的访问权限</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="nf">modifiers</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="na">getModifiers</span><span class="p">();</span> 
<span class="n">Modifier</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">modifiers</span><span class="p">);</span> </code></pre></div></li>
</ol></li>
</ol>

<h3 id="invoke方法">Invoke方法</h3>

<p>比较重点</p>

<p>invoke方法的实现：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@CallerSensitive</span>
<span class="kd">public</span> <span class="nf">Object</span> <span class="n">invoke</span><span class="p">(</span><span class="n">Object</span> <span class="nf">obj</span><span class="p">,</span> <span class="n">Object</span><span class="p">...</span> <span class="nf">args</span><span class="p">)</span>
    <span class="kd">throws</span> <span class="nf">IllegalAccessException</span><span class="p">,</span> <span class="n">IllegalArgumentException</span><span class="p">,</span>
       <span class="n">InvocationTargetException</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">override</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Reflection</span><span class="p">.</span><span class="na">quickCheckMemberAccess</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="n">Reflection</span><span class="p">.</span><span class="na">getCallerClass</span><span class="p">();</span>
            <span class="n">checkAccess</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">MethodAccessor</span> <span class="nf">ma</span> <span class="o">=</span> <span class="n">methodAccessor</span><span class="p">;</span>             <span class="c1">// read volatile
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ma</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">acquireMethodAccessor</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ma</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<ol>
<li>权限检查</li>
</ol>

<p>首先检查AccessibleObject的override属性的值 。AccessibleObject 类是 Field、Method 和 Constructor 对象的基类 。override 默认为false,调试需要权限调用规则，反正不需要。</p>

<p>默认情况下首先用Reflection.quickCheckMemberAccess(clazz, modifiers)方法检查方法是否为public，如果是的话跳出本步；如果不是public方法，那么用Reflection.getCallerClass()方法获取调用这个方法的Class对象，这是一个native方法:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="nd">@CallerSensitive</span>
       <span class="kd">public</span> <span class="nf">static</span> <span class="kd">native</span> <span class="nf">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getCallerClass</span><span class="p">();</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="n">JNIEXPORT</span> <span class="nf">jclass</span> <span class="n">JNICALL</span> <span class="nf">Java_sun_reflect_Reflection_getCallerClass__</span>
   <span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="nf">unused</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="n">JVM_GetCallerClass</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">JVM_CALLER_DEPTH</span><span class="p">);</span>
   <span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++">   <span class="n">JVM_ENTRY</span><span class="p">(</span><span class="n">jclass</span><span class="p">,</span> <span class="n">JVM_GetCallerClass</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">))</span>
     <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_GetCallerClass&#34;</span><span class="p">);</span>
   
     <span class="c1">// Pre-JDK 8 and early builds of JDK 8 don&#39;t have a CallerSensitive annotation; or
</span><span class="c1"></span>     <span class="c1">// sun.reflect.Reflection.getCallerClass with a depth parameter is provided
</span><span class="c1"></span>     <span class="c1">// temporarily for existing code to use until a replacement API is defined.
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="n">SystemDictionary</span><span class="o">::</span><span class="n">reflect_CallerSensitive_klass</span><span class="p">()</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">depth</span> <span class="o">!=</span> <span class="n">JVM_CALLER_DEPTH</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">Klass</span><span class="o">*</span> <span class="n">k</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">security_get_caller_class</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
       <span class="k">return</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="p">(</span><span class="n">jclass</span><span class="p">)</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">make_local</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">java_mirror</span><span class="p">());</span>
     <span class="p">}</span>
   
     <span class="c1">// Getting the class of the caller frame.
</span><span class="c1"></span>     <span class="c1">//
</span><span class="c1"></span>     <span class="c1">// The call stack at this point looks something like this:
</span><span class="c1"></span>     <span class="c1">//
</span><span class="c1"></span>     <span class="c1">// [0] [ @CallerSensitive public sun.reflect.Reflection.getCallerClass ]
</span><span class="c1"></span>     <span class="c1">// [1] [ @CallerSensitive API.method                                   ]
</span><span class="c1"></span>     <span class="c1">// [.] [ (skipped intermediate frames)                                 ]
</span><span class="c1"></span>     <span class="c1">// [n] [ caller                                                        ]
</span><span class="c1"></span>     <span class="n">vframeStream</span> <span class="n">vfst</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
     <span class="c1">// Cf. LibraryCallKit::inline_native_Reflection_getCallerClass
</span><span class="c1"></span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">vfst</span><span class="p">.</span><span class="n">at_end</span><span class="p">();</span> <span class="n">vfst</span><span class="p">.</span><span class="n">security_next</span><span class="p">(),</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">Method</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">vfst</span><span class="p">.</span><span class="n">method</span><span class="p">();</span>
       <span class="n">assert</span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;sanity&#34;</span><span class="p">);</span>
       <span class="k">switch</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
         <span class="c1">// This must only be called from Reflection.getCallerClass
</span><span class="c1"></span>         <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">intrinsic_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">vmIntrinsics</span><span class="o">::</span><span class="n">_getCallerClass</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">THROW_MSG_NULL</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_InternalError</span><span class="p">(),</span> <span class="s">&#34;JVM_GetCallerClass must only be called from Reflection.getCallerClass&#34;</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="c1">// fall-through
</span><span class="c1"></span>       <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
         <span class="c1">// Frame 0 and 1 must be caller sensitive.
</span><span class="c1"></span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">caller_sensitive</span><span class="p">())</span> <span class="p">{</span>
           <span class="n">THROW_MSG_NULL</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_InternalError</span><span class="p">(),</span> <span class="n">err_msg</span><span class="p">(</span><span class="s">&#34;CallerSensitive annotation expected at frame %d&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>
       <span class="k">default</span><span class="o">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">is_ignored_by_security_stack_walk</span><span class="p">())</span> <span class="p">{</span>
           <span class="c1">// We have reached the desired frame; return the holder class.
</span><span class="c1"></span>           <span class="k">return</span> <span class="p">(</span><span class="n">jclass</span><span class="p">)</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">make_local</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">method_holder</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">java_mirror</span><span class="p">());</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">JVM_END</span>
</code></pre></div>
<p>获取了这个Class对象caller后用checkAccess方法做一次快速的权限校验 :</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">volatile</span> <span class="nf">Object</span> <span class="n">securityCheckCache</span><span class="p">;</span>
   
       <span class="kt">void</span> <span class="nf">checkAccess</span><span class="p">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">caller</span><span class="p">,</span> <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">Object</span> <span class="nf">obj</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">modifiers</span><span class="p">)</span>
           <span class="kd">throws</span> <span class="nf">IllegalAccessException</span>
       <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">caller</span> <span class="o">==</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 快速校验
</span><span class="c1"></span>               <span class="k">return</span><span class="p">;</span>             <span class="c1">// 权限通过校验
</span><span class="c1"></span>           <span class="p">}</span>
           <span class="n">Object</span> <span class="nf">cache</span> <span class="o">=</span> <span class="n">securityCheckCache</span><span class="p">;</span>  <span class="c1">// read volatile
</span><span class="c1"></span>           <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">clazz</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span>
               <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">Modifier</span><span class="p">.</span><span class="na">isProtected</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
               <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">((</span><span class="n">targetClass</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="na">getClass</span><span class="p">())</span> <span class="o">!=</span> <span class="n">clazz</span><span class="p">))</span> <span class="p">{</span>
               <span class="c1">// Must match a 2-list of { caller, targetClass }.
</span><span class="c1"></span>               <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="nf">instanceof</span> <span class="n">Class</span><span class="p">[])</span> <span class="p">{</span>
                   <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;[]</span> <span class="n">cache2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;[])</span> <span class="n">cache</span><span class="p">;</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">cache2</span><span class="p">[</span><span class="n">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">targetClass</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span>
                       <span class="n">cache2</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">caller</span><span class="p">)</span> <span class="p">{</span>
                       <span class="k">return</span><span class="p">;</span>     <span class="c1">// ACCESS IS OK
</span><span class="c1"></span>                   <span class="p">}</span>
                   <span class="c1">// (Test cache[1] first since range check for [1]
</span><span class="c1"></span>                   <span class="c1">// subsumes range check for [0].)
</span><span class="c1"></span>               <span class="p">}</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">==</span> <span class="n">caller</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// Non-protected case (or obj.class == this.clazz).
</span><span class="c1"></span>               <span class="k">return</span><span class="p">;</span>             <span class="c1">// ACCESS IS OK
</span><span class="c1"></span>           <span class="p">}</span>
   
           <span class="c1">// If no return, fall through to the slow path.
</span><span class="c1"></span>           <span class="n">slowCheckMemberAccess</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">targetClass</span><span class="p">);</span>
       <span class="p">}</span></code></pre></div>
<p>先快速检查，未通过的话建立缓存，中间再检查；</p>

<p>如果都没有通过：进行更详细的检查;</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="c1">// Keep all this slow stuff out of line:
</span><span class="c1"></span>   <span class="kt">void</span> <span class="nf">slowCheckMemberAccess</span><span class="p">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">caller</span><span class="p">,</span> <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">Object</span> <span class="nf">obj</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">modifiers</span><span class="p">,</span>
                              <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">targetClass</span><span class="p">)</span>
       <span class="kd">throws</span> <span class="nf">IllegalAccessException</span>
   <span class="p">{</span>
       <span class="n">Reflection</span><span class="p">.</span><span class="na">ensureMemberAccess</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">);</span>
   
       <span class="c1">// Success: Update the cache.
</span><span class="c1"></span>       <span class="n">Object</span> <span class="nf">cache</span> <span class="o">=</span> <span class="p">((</span><span class="n">targetClass</span> <span class="o">==</span> <span class="n">clazz</span><span class="p">)</span>
                       <span class="o">?</span> <span class="n">caller</span>
                       <span class="o">:</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">?&amp;</span><span class="n">gt</span><span class="p">;[]</span> <span class="p">{</span> <span class="n">caller</span><span class="p">,</span> <span class="n">targetClass</span> <span class="p">});</span>
   
       <span class="c1">// Note:  The two cache elements are not volatile,
</span><span class="c1"></span>       <span class="c1">// but they are effectively final.  The Java memory model
</span><span class="c1"></span>       <span class="c1">// guarantees that the initializing stores for the cache
</span><span class="c1"></span>       <span class="c1">// elements will occur before the volatile write.
</span><span class="c1"></span>       <span class="n">securityCheckCache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>         <span class="c1">// write volatile
</span><span class="c1"></span>   <span class="p">}</span></code></pre></div>
<p>用Reflection.ensureMemberAccess方法继续检查权限，若检查通过就更新缓存，这样下一次同一个类调用同一个方法时就不用执行权限检查了，这是一种简单的缓存机制。</p>

<ol>
<li><p>调用MethodAccessor的invoke方法</p>

<p>由sun.reflect.MethodAccessor 处理</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="cm">/** This interface provides the declaration for
</span><span class="cm">       java.lang.reflect.Method.invoke(). Each Method object is
</span><span class="cm">       configured with a (possibly dynamically-generated) class which
</span><span class="cm">       implements this interface.
</span><span class="cm">   */</span>
    <span class="kd">public</span> <span class="nf">interface</span> <span class="n">MethodAccessor</span> <span class="p">{</span>    <span class="c1">//是一个接口
</span><span class="c1"></span>       <span class="cm">/** Matches specification in {@link java.lang.reflect.Method} */</span>
       <span class="kd">public</span> <span class="nf">Object</span> <span class="n">invoke</span><span class="p">(</span><span class="n">Object</span> <span class="nf">obj</span><span class="p">,</span> <span class="n">Object</span><span class="p">[]</span> <span class="nf">args</span><span class="p">)</span>
           <span class="kd">throws</span> <span class="nf">IllegalArgumentException</span><span class="p">,</span> <span class="n">InvocationTargetException</span><span class="p">;</span>
   <span class="p">}</span></code></pre></div>
<p>分析其Usage可得它的具体实现类有:</p>

<ul>
<li>sun.reflect.DelegatingMethodAccessorImpl</li>
<li>sun.reflect.MethodAccessorImpl</li>
<li>sun.reflect.NativeMethodAccessorImpl</li>
</ul>

<p>methodAccessor实例由reflectionFactory对象操控生成，它在AccessibleObject下的声明如下:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="c1">// Reflection factory used by subclasses for creating field,
</span><span class="c1"></span>   <span class="c1">// method, and constructor accessors. Note that this is called
</span><span class="c1"></span>   <span class="c1">// very early in the bootstrapping process.
</span><span class="c1"></span>   <span class="kd">static</span> <span class="nf">final</span> <span class="n">ReflectionFactory</span> <span class="nf">reflectionFactory</span> <span class="o">=</span>
       <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span>
           <span class="k">new</span> <span class="n">sun</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">ReflectionFactory</span><span class="p">.</span><span class="na">GetReflectionFactoryAction</span><span class="p">());</span></code></pre></div>
<p>sun.reflect.ReflectionFactory类的源码：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="nf">class</span> <span class="n">ReflectionFactory</span> <span class="p">{</span>
       
       <span class="kd">private</span> <span class="nf">static</span> <span class="kt">boolean</span> <span class="nf">initted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
       <span class="kd">private</span> <span class="nf">static</span> <span class="n">Permission</span> <span class="nf">reflectionFactoryAccessPerm</span>
           <span class="o">=</span> <span class="k">new</span> <span class="n">RuntimePermission</span><span class="p">(</span><span class="s">&#34;reflectionFactoryAccess&#34;</span><span class="p">);</span>
       <span class="kd">private</span> <span class="nf">static</span> <span class="n">ReflectionFactory</span> <span class="nf">soleInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReflectionFactory</span><span class="p">();</span>
       <span class="c1">// Provides access to package-private mechanisms in java.lang.reflect
</span><span class="c1"></span>       <span class="kd">private</span> <span class="nf">static</span> <span class="kd">volatile</span> <span class="nf">LangReflectAccess</span> <span class="n">langReflectAccess</span><span class="p">;</span>
       
       <span class="c1">// 这里设计得非常巧妙
</span><span class="c1"></span>       <span class="c1">// &#34;Inflation&#34; mechanism. Loading bytecodes to implement
</span><span class="c1"></span>       <span class="c1">// Method.invoke() and Constructor.newInstance() currently costs
</span><span class="c1"></span>       <span class="c1">// 3-4x more than an invocation via native code for the first
</span><span class="c1"></span>       <span class="c1">// invocation (though subsequent invocations have been benchmarked
</span><span class="c1"></span>       <span class="c1">// to be over 20x faster). Unfortunately this cost increases
</span><span class="c1"></span>       <span class="c1">// startup time for certain applications that use reflection
</span><span class="c1"></span>       <span class="c1">// intensively (but only once per class) to bootstrap themselves.
</span><span class="c1"></span>       <span class="c1">// To avoid this penalty we reuse the existing JVM entry points
</span><span class="c1"></span>       <span class="c1">// for the first few invocations of Methods and Constructors and
</span><span class="c1"></span>       <span class="c1">// then switch to the bytecode-based implementations.
</span><span class="c1"></span>       <span class="c1">//
</span><span class="c1"></span>       <span class="c1">// Package-private to be accessible to NativeMethodAccessorImpl
</span><span class="c1"></span>       <span class="c1">// and NativeConstructorAccessorImpl
</span><span class="c1"></span>       <span class="kd">private</span> <span class="nf">static</span> <span class="kt">boolean</span> <span class="nf">noInflation</span>        <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
       <span class="kd">private</span> <span class="nf">static</span> <span class="kt">int</span>     <span class="nf">inflationThreshold</span> <span class="o">=</span> <span class="n">15</span><span class="p">;</span>
       
       <span class="c1">//......
</span><span class="c1"></span>       
    <span class="c1">//这是生成MethodAccessor的方法
</span><span class="c1"></span>       <span class="kd">public</span> <span class="nf">MethodAccessor</span> <span class="n">newMethodAccessor</span><span class="p">(</span><span class="n">Method</span> <span class="nf">method</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">checkInitted</span><span class="p">();</span>
       
           <span class="k">if</span> <span class="p">(</span><span class="n">noInflation</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ReflectUtil</span><span class="p">.</span><span class="na">isVMAnonymousClass</span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getDeclaringClass</span><span class="p">()))</span> <span class="p">{</span>
               <span class="k">return</span> <span class="k">new</span> <span class="n">MethodAccessorGenerator</span><span class="p">().</span>
                   <span class="n">generateMethod</span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getDeclaringClass</span><span class="p">(),</span>
                                  <span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span>
                                  <span class="n">method</span><span class="p">.</span><span class="na">getParameterTypes</span><span class="p">(),</span>
                                  <span class="n">method</span><span class="p">.</span><span class="na">getReturnType</span><span class="p">(),</span>
                                  <span class="n">method</span><span class="p">.</span><span class="na">getExceptionTypes</span><span class="p">(),</span>
                                  <span class="n">method</span><span class="p">.</span><span class="na">getModifiers</span><span class="p">());</span>
           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">NativeMethodAccessorImpl</span> <span class="nf">acc</span> <span class="o">=</span>
                   <span class="k">new</span> <span class="n">NativeMethodAccessorImpl</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
               <span class="n">DelegatingMethodAccessorImpl</span> <span class="nf">res</span> <span class="o">=</span>
                   <span class="k">new</span> <span class="n">DelegatingMethodAccessorImpl</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
               <span class="n">acc</span><span class="p">.</span><span class="na">setParent</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
               <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
           <span class="p">}</span>
       <span class="p">}</span>
       
       <span class="c1">//......
</span><span class="c1"></span>       
       <span class="cm">/** We have to defer full initialization of this class until after
</span><span class="cm">       the static initializer is run since java.lang.reflect.Method&#39;s
</span><span class="cm">       static initializer (more properly, that for
</span><span class="cm">       java.lang.reflect.AccessibleObject) causes this class&#39;s to be
</span><span class="cm">       run, before the system properties are set up. */</span>
       <span class="kd">private</span> <span class="nf">static</span> <span class="kt">void</span> <span class="nf">checkInitted</span><span class="p">()</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">initted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
           <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span>
               <span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
                   <span class="kd">public</span> <span class="nf">Void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
                       <span class="c1">// Tests to ensure the system properties table is fully
</span><span class="c1"></span>                       <span class="c1">// initialized. This is needed because reflection code is
</span><span class="c1"></span>                       <span class="c1">// called very early in the initialization process (before
</span><span class="c1"></span>                       <span class="c1">// command-line arguments have been parsed and therefore
</span><span class="c1"></span>                       <span class="c1">// these user-settable properties installed.) We assume that
</span><span class="c1"></span>                       <span class="c1">// if System.out is non-null then the System class has been
</span><span class="c1"></span>                       <span class="c1">// fully initialized and that the bulk of the startup code
</span><span class="c1"></span>                       <span class="c1">// has been run.
</span><span class="c1"></span>       
                       <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                           <span class="c1">// java.lang.System not yet fully initialized
</span><span class="c1"></span>                           <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                       <span class="p">}</span>
       
                       <span class="n">String</span> <span class="nf">val</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;sun.reflect.noInflation&#34;</span><span class="p">);</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;true&#34;</span><span class="p">))</span> <span class="p">{</span>
                           <span class="n">noInflation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                       <span class="p">}</span>
       
                       <span class="n">val</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;sun.reflect.inflationThreshold&#34;</span><span class="p">);</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">try</span> <span class="p">{</span>
                               <span class="n">inflationThreshold</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
                           <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">NumberFormatException</span> <span class="nf">e</span><span class="p">)</span> <span class="p">{</span>
                               <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;Unable to parse property sun.reflect.inflationThreshold&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                           <span class="p">}</span>
                       <span class="p">}</span>
       
                       <span class="n">initted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                       <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                   <span class="p">}</span>
               <span class="p">});</span>
       <span class="p">}</span>
   <span class="p">}</span></code></pre></div>
<p>MethodAccessor实现有两个版本，一个是Java版本，一个是native版本 。</p>

<p>Java实现的版本在初始化时需要较多时间，但长久来说性能较好；native版本正好相反，启动时相对较快，但运行时间长了之后速度就比不过Java版了</p>

<p>为了尽可能地减少性能损耗，HotSpot JDK采用“inflation”的技巧：让Java方法在被反射调用时，开头若干次使用native版，等反射调用次数超过阈值时则生成一个专用的MethodAccessor实现类，生成其中的invoke()方法的字节码，以后对该Java方法的反射调用就会使用Java版本。 这项优化是从JDK 1.4开始的。</p>

<ol>
<li><p>在JVM层面探究invoke0方法</p>

<p>invoke0方法是一个native方法,它在HotSpot JVM里调用JVM_InvokeMethod函数:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++">  <span class="n">JNIEXPORT</span> <span class="n">jobject</span> <span class="n">JNICALL</span> <span class="nf">Java_sun_reflect_NativeMethodAccessorImpl_invoke0</span>
  <span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">unused</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">m</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="n">JVM_InvokeMethod</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></li>
</ol></li>
</ol>

<p>openjdk/hotspot/src/share/vm/prims/jvm.cpp</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">JVM_ENTRY</span><span class="p">(</span><span class="n">jobject</span><span class="p">,</span> <span class="n">JVM_InvokeMethod</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">method</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">args0</span><span class="p">))</span>
  <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_InvokeMethod&#34;</span><span class="p">);</span>
  <span class="n">Handle</span> <span class="n">method_handle</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">stack_available</span><span class="p">((</span><span class="n">address</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">method_handle</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">JVMInvokeMethodSlack</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">method_handle</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">method</span><span class="p">));</span>
    <span class="n">Handle</span> <span class="nf">receiver</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
    <span class="n">objArrayHandle</span> <span class="nf">args</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">objArrayOop</span><span class="p">(</span><span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">args0</span><span class="p">)));</span>
    <span class="n">oop</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Reflection</span><span class="o">::</span><span class="n">invoke_method</span><span class="p">(</span><span class="n">method_handle</span><span class="p">(),</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">CHECK_NULL</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">res</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">make_local</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">JvmtiExport</span><span class="o">::</span><span class="n">should_post_vm_object_alloc</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">oop</span> <span class="n">ret_type</span> <span class="o">=</span> <span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="n">return_type</span><span class="p">(</span><span class="n">method_handle</span><span class="p">());</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">ret_type</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;sanity check: ret_type oop must not be NULL!&#34;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Class</span><span class="o">::</span><span class="n">is_primitive</span><span class="p">(</span><span class="n">ret_type</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Only for primitive type vm allocates memory for java object.
</span><span class="c1"></span>        <span class="c1">// See box() method.
</span><span class="c1"></span>        <span class="n">JvmtiExport</span><span class="o">::</span><span class="n">post_vm_object_alloc</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">::</span><span class="n">current</span><span class="p">(),</span> <span class="n">result</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">THROW_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_StackOverflowError</span><span class="p">());</span>
  <span class="p">}</span>
<span class="n">JVM_END</span>
</code></pre></div>
<p>openjdk/hotspot/src/share/vm/runtime/reflection.cpp :</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">oop</span> <span class="n">Reflection</span><span class="o">::</span><span class="n">invoke_method</span><span class="p">(</span><span class="n">oop</span> <span class="n">method_mirror</span><span class="p">,</span> <span class="n">Handle</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">objArrayHandle</span> <span class="n">args</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">oop</span> <span class="n">mirror</span>             <span class="o">=</span> <span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="n">clazz</span><span class="p">(</span><span class="n">method_mirror</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">slot</span>               <span class="o">=</span> <span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="n">slot</span><span class="p">(</span><span class="n">method_mirror</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="k">override</span>          <span class="o">=</span> <span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="k">override</span><span class="p">(</span><span class="n">method_mirror</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">objArrayHandle</span> <span class="nf">ptypes</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">objArrayOop</span><span class="p">(</span><span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="n">parameter_types</span><span class="p">(</span><span class="n">method_mirror</span><span class="p">)));</span>

  <span class="n">oop</span> <span class="n">return_type_mirror</span> <span class="o">=</span> <span class="n">java_lang_reflect_Method</span><span class="o">::</span><span class="n">return_type</span><span class="p">(</span><span class="n">method_mirror</span><span class="p">);</span>
  <span class="n">BasicType</span> <span class="n">rtype</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Class</span><span class="o">::</span><span class="n">is_primitive</span><span class="p">(</span><span class="n">return_type_mirror</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">rtype</span> <span class="o">=</span> <span class="n">basic_type_mirror_to_basic_type</span><span class="p">(</span><span class="n">return_type_mirror</span><span class="p">,</span> <span class="n">CHECK_NULL</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">rtype</span> <span class="o">=</span> <span class="n">T_OBJECT</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">instanceKlassHandle</span> <span class="n">klass</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">java_lang_Class</span><span class="o">::</span><span class="n">as_Klass</span><span class="p">(</span><span class="n">mirror</span><span class="p">));</span>
  <span class="n">Method</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">klass</span><span class="o">-&gt;</span><span class="n">method_with_idnum</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">THROW_MSG_0</span><span class="p">(</span><span class="n">vmSymbols</span><span class="o">::</span><span class="n">java_lang_InternalError</span><span class="p">(),</span> <span class="s">&#34;invoke&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">methodHandle</span> <span class="n">method</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

  <span class="k">return</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="k">override</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>Java版的实现</li>
</ol>

<p>Java版MethodAccessor的生成使用MethodAccessorGenerator实现  下面是开头的注释：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/** Generator for sun.reflect.MethodAccessor and
</span><span class="cm">    sun.reflect.ConstructorAccessor objects using bytecodes to
</span><span class="cm">    implement reflection. A java.lang.reflect.Method or
</span><span class="cm">    java.lang.reflect.Constructor object can delegate its invoke or
</span><span class="cm">    newInstance method to an accessor using native code or to one
</span><span class="cm">    generated by this class. (Methods and Constructors were merged
</span><span class="cm">    together in this class to ensure maximum code sharing.) */</span></code></pre></div>

        </div>
        <footer>
            <hr>
            
        <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://vorblock.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
    <script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>

    
    <script>
        (function(){function center_el(tagName){var tags=document.getElementsByTagName(tagName),i,tag;for(i=0;i<tags.length;i++){tag=tags[i];var parent=tag.parentElement;if(parent.childNodes.length===1){if(parent.nodeName==='A'){parent=parent.parentElement;if(parent.childNodes.length!=1)continue;parent.firstChild.style.border='none';}
if(parent.nodeName==='P')parent.style.textAlign='center';}}}
var tagNames=['img','embed','object'];for(var i=0;i<tagNames.length;i++){center_el(tagNames[i]);}})();
    </script>
    
            <div class="copyright">
                <span class="copyright">&copy;2017-2019 vorblock - <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></span>
            </div>
        </footer>
    </article>
</body>

</html>