<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>(转)Android Inline Hook中的指令修复详解 - {Vorblock&gt;&gt;&gt;blog}</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="GToad" /><meta name="description" content="Android Inline Hook中的指令修复详解" />
<meta name="keywords" content="Android, Hook, Inline, 指令修复" />







<meta name="generator" content="Hugo 0.54.0" />


<link rel="canonical" href="https://naivete.cc/post/android-inline-hook%E4%B8%AD%E7%9A%84%E6%8C%87%E4%BB%A4%E4%BF%AE%E5%A4%8D%E8%AF%A6%E8%A7%A3/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.400abd73e639ce41b46f3a6c24c8500aa80f1209326d3c4ae0a13e2fc867e079.css" integrity="sha256-QAq9c&#43;Y5zkG0bzpsJMhQCqgPEgkybTxK4KE&#43;L8hn4Hk=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="(转)Android Inline Hook中的指令修复详解" />
<meta property="og:description" content="Android Inline Hook中的指令修复详解" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://naivete.cc/post/android-inline-hook%E4%B8%AD%E7%9A%84%E6%8C%87%E4%BB%A4%E4%BF%AE%E5%A4%8D%E8%AF%A6%E8%A7%A3/" />
<meta property="article:published_time" content="2018-07-30T15:03:41&#43;08:00"/>
<meta property="article:modified_time" content="2018-07-30T15:03:41&#43;08:00"/>

<meta itemprop="name" content="(转)Android Inline Hook中的指令修复详解">
<meta itemprop="description" content="Android Inline Hook中的指令修复详解">


<meta itemprop="datePublished" content="2018-07-30T15:03:41&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-30T15:03:41&#43;08:00" />
<meta itemprop="wordCount" content="7564">



<meta itemprop="keywords" content="Android安全,Hook,指令修复," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="(转)Android Inline Hook中的指令修复详解"/>
<meta name="twitter:description" content="Android Inline Hook中的指令修复详解"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Vorblock</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/daily/">Daily</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Vorblock
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://naivete.cc/daily/">Daily</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">(转)Android Inline Hook中的指令修复详解</h1>
      
      <div class="post-meta">
        <time datetime="2018-07-30" class="post-time">
          2018-07-30
        </time>
        <div class="post-category">
            
          </div>
        <span class="more-meta"> 约 7564 字 </span>
          <span class="more-meta"> 预计阅读 16 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#条件跳转-以thumb16为例">条件跳转（以Thumb16为例）</a>
<ul>
<li>
<ul>
<li><a href="#跳转目标在备份代码中">跳转目标在备份代码中</a></li>
</ul></li>
</ul></li>
<li><a href="#arm32">ARM32</a>
<ul>
<li>
<ul>
<li><a href="#blx-bl-b-bx">BLX, BL, B, BX</a></li>
<li><a href="#add">ADD</a></li>
<li><a href="#adr-ldr-mov">ADR, LDR, MOV</a></li>
<li><a href="#其它指令">其它指令</a></li>
</ul></li>
</ul></li>
<li><a href="#thumb16">Thumb16</a>
<ul>
<li>
<ul>
<li><a href="#b-bx">B, BX</a></li>
<li><a href="#add-1">ADD</a></li>
<li><a href="#mov-adr-ldr">MOV, ADR, LDR</a></li>
<li><a href="#cbz-cbnz">CBZ, CBNZ</a></li>
<li><a href="#其它指令-1">其它指令</a></li>
</ul></li>
</ul></li>
<li><a href="#thumb32">Thumb32</a>
<ul>
<li>
<ul>
<li><a href="#b-bx-blx-bl">B, BX, BLX, BL</a></li>
<li><a href="#tbb-tbh">TBB, TBH</a></li>
<li><a href="#adr-ldr">ADR, LDR</a></li>
<li><a href="#其它指令-2">其它指令</a></li>
</ul></li>
</ul></li>
<li><a href="#局限性思考">局限性思考</a>
<ul>
<li>
<ul>
<li><a href="#局限分析1">局限分析1</a></li>
<li><a href="#使用指导1">使用指导1</a></li>
<li><a href="#局限分析2">局限分析2</a></li>
<li><a href="#使用指导2">使用指导2</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="前言">前言</h2>

<blockquote>
<p>本文是另一篇<a href="https://gtoad.github.io/2018/07/06/Android-Native-Hook-Practice/">《Android Native Hook工具实践》</a>的一份补充文章，本人建议各位学习者先去看该篇主文以了解本文的需求背景。本文将会对该文中<code>指令修复</code>部分的技术细节进行阐述。本文的部分源码来自于<a href="http://ele7enxxh.com/Android-Arm-Inline-Hook.html">ele7enxxh大神的项目</a>，由于大神的技术博客里解释省略了较多细节，所以出于学习的目的，本人也会一点一点慢慢啃。同时由于该库并不完善，因此本文将补充该库没考虑到的一些修复指令方案，并且对许多特殊状况和Bug也尽力解决。</p>
</blockquote>

<p>目前需要进行指令修复的ARM32指令主要可以分为如下几类：</p>

<ol>
<li>BLX_ARM, BL_ARM, B_ARM（不包含条件跳转）, BX_ARM</li>
<li>条件跳转BEQ_ARM BNE_ARM BCS_ARM BCC_ARM BMI_ARM BPL_ARM BVS_ARM BVC_ARM BHI_ARM BLS_ARM BGE_ARM BLT_ARM BGT_ARM BLE_ARM</li>
<li>ADD_ARM</li>
<li>ADR_ARM, LDR_ARM, MOV_ARM</li>
<li>其它指令 OTHER_ARM</li>
</ol>

<p>Thumb16指令主要可以分为如下几类：</p>

<ol>
<li>B1_THUMB16（不包含条件跳转）, B2_THUMB16, BX_THUMB16</li>
<li>条件跳转B1_BEQ_THUMB16, B1_BNE_THUMB16, B1_BCS_THUMB16, B1_BCC_THUMB16, B1_BMI_THUMB16, B1_BPL_THUMB16, B1_BVS_THUMB16, B1_BVC_THUMB16, B1_BHI_THUMB16, B1_BLS_THUMB16, B1_BGE_THUMB16, B1_BLT_THUMB16, B1_BGT_THUMB16, B1_BLE_THUMB16</li>
<li>ADD_THUMB16</li>
<li>MOV_THUMB16, ADR_THUMB16, LDR_THUMB16</li>
<li>其它指令 OTHER_THUMB16</li>
</ol>

<p>Thumb32指令主要可以分为如下几类：</p>

<ol>
<li>B1_THUMB32（不包含条件跳转）, B2_THUMB32, BX_THUMB32, BLX_THUMB32, BL_THUMB32</li>
<li>条件跳转B1_BEQ_THUMB32, B1_BNE_THUMB32, B1_BCS_THUMB32, B1_BCC_THUMB32, B1_BMI_THUMB32, B1_BPL_THUMB32, B1_BVS_THUMB32, B1_BVC_THUMB32, B1_BHI_THUMB32, B1_BLS_THUMB32, B1_BGE_THUMB32, B1_BLT_THUMB32, B1_BGT_THUMB32, B1_BLE_THUMB32</li>
<li>TBB_THUMB32, TBH_THUMB32</li>
<li>ADR1_THUMB32, ADR2_THUMB32, LDR_THUMB32</li>
<li>其它指令 OTHER_THUMB32</li>
</ol>

<p>下面我来一一分析它们具体的修复方案。其中条件跳转指令先单独拿出来作为一个部分进行讲解。</p>

<h2 id="条件跳转-以thumb16为例">条件跳转（以Thumb16为例）</h2>

<p>在ARM32、Thumb16、Thumb32中都是有条件跳转的指令的，本项目三套都修复了。下面来讲一下Thumb16下条件跳转的修复，因为三套指令的修复思路都是一样的。</p>

<p>条件跳转指令的修复相比于其它种类的指令有一个明显恶心的地方，看下面两张图可以很明显看出来，先看第一张：</p>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150501.png" alt="" /></p>

<p>12 Bytes的备份代码与各自对应的修复代码自上而下一一对应，尾部再添加个跳转回原程序的LDR。这就是上文中设想的最标准的修复方式。然而当其中混入了一条条件跳转指令后：</p>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150529.png" alt="" /></p>

<p>我们发现按照原程序的顺序和逻辑去修复条件跳转指令的话，会导致条件跳转指令对应的修复指令（图中红色部分）不是完整的一部分，而且第二部分需要出现在返回原程序跳转的后面才能保持原来的程序逻辑。这时有两个问题：</p>

<ol>
<li>图中X的值如何确定？我们是从上到下一条条修复备份指令然后拼接的，也就是说这条BLS指令下方的指令在修复它的时候还没被修复。这样这个X的值就无法确定？</li>
<li>Thumb-2模式在备份时，12 Bytes最大是可能备份6条Thumb16指令的。也就是说，可能在备份指令中出现多条条件跳转指令，这时候会出现跳转嵌套，如下图：</li>
</ol>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150552.png" alt="" /></p>

<p>为了解决第一个问题，本人先在Hook一开始的init函数中建立一个记录所有备份指令修复后长度的数组<code>pstInlineHook-&gt;backUpFixLengthList</code>，然后当修复条件跳转指令时，通过计算其后面修复指令的长度来得到X的值。这个方法一开始只是用来解决问题1的，当时还没想到问题2的情况。因为这个数组中看不出后面的指令是否存在其它条件跳转指令，所以最后的跳转嵌套时会出错。那第二个问题如何解决呢？本人开始意识到如果条件跳转指令要用这种”两段“式的修复方式的话，会使得之后的修复逻辑变得很复杂。但是按照原程序的执行逻辑顺序似乎又只能这么做…吗？不，第一次优化方案如下所示：</p>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150619.png" alt="" /></p>

<p>这个方案通过连续的三个跳转命令来缩小这个BXX结构，使其按照原来的逻辑跳转到符合条件的跳转指令去，然后再跳转一次。至此其实已经解决了当前遇到的“两段”式麻烦。但是最后本人又想到了一个新的优化方案：<code>逆向思维方案</code>，可以简化跳转逻辑并在Arm32和Thumb32下减少一条跳转指令的空间（Thumb16下由于需要补NOP所以没有减小空间占用），如下图：</p>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150645.png" alt="" /></p>

<p>图中可以看到，原来的BLS指令被转化为了BHI指令，也就是<code>小于等于</code>的跳转逻辑变成了<code>大于</code>。这样一来，原本跳转的目标逻辑现在就可以紧贴到BHI指令下面。从而使得条件跳转指令的修复代码也和其它指令一样，成为一个连续的代码段。并且BHI后面的参数在Thumb16中将固定为12。那么对于多条条件跳转指令来说呢？如下图：</p>

<p><img src="http://my-md-1253484710.coscd.myqcloud.com/20180730150709.png" alt="" /></p>

<p>从图中可以看出来，又回到了最初从上到下一一对应，末尾跳转的形式。而之前新增的<code>pstInlineHook-&gt;backUpFixLengthList</code>数组依然保留了，因为当跳转的目标地址依然在备份代码范围内时需要用到它，下一部分中将会介绍。</p>

<h4 id="跳转目标在备份代码中">跳转目标在备份代码中</h4>

<p>上文提到，如果我们备份代码中的跳转指令依然是跳到备份代码中呢？虽然我们的备份代码很短，但现实测试中的确遇到了这样的场景。出现了B 2的情况，可能是由于部分编译器把这个作为NOP指令吧。因此我们需要解决一下。</p>

<ol>
<li>判断跳转的目标地址是否在备份代码范围内。</li>
<li>如果不在的话，一切照旧；在的话那就计算跳转目标在备份代码中的偏移OFFSET1。</li>
<li>利用Hook初始化时候统计的<code>pstInlineHook-&gt;backUpFixLengthList</code>数组和偏移OFFSET1来推算出在修复指令中的新偏移OFFSET2。</li>
<li>导入修复指令在内存中的地址ADDR1，然后用ADDR1+OFFSET2即可得到新的跳转地址Value。</li>
<li>根据Arm/Thumb模式来选择是否对Value+1。</li>
<li>用新的Value代替原本计算得到的绝对跳转地址。</li>
</ol>

<p>这个处理过程的一个关键点在于虽然我们还没有修复条件跳转指令之后的备份指令，但是它们修复后的长度是可以预测的，每种指令各自的修复指令长度是固定的。因此可以在在修复下方指令前预测出跳转偏移长度。</p>

<h2 id="arm32">ARM32</h2>

<h4 id="blx-bl-b-bx">BLX, BL, B, BX</h4>

<p>修复代码如下：</p>

<pre><code>    if (type == BLX_ARM || type == BL_ARM || type == B_ARM || type == BX_ARM) {
        uint32_t x;
        int top_bit;
        uint32_t imm32;
        uint32_t value;

        if (type == BLX_ARM || type == BL_ARM) {
            // ADD LR, PC, #4 
            trampoline_instructions[trampoline_pos++] = 0xE28FE004; 
        }
        // LDR PC, [PC, #-4] 
        trampoline_instructions[trampoline_pos++] = 0xE51FF004;     
        if (type == BLX_ARM) {
            //BLX_ARM 
            x = ((instruction &amp; 0xFFFFFF) &lt;&lt; 2) | ((instruction &amp; 0x1000000) &gt;&gt; 23); 
        }
        else if (type == BL_ARM || type == B_ARM) {
            //BL_ARM B_ARM 
            x = (instruction &amp; 0xFFFFFF) &lt;&lt; 2;                                       
        }
        else {
            //BX_ARM            
            x = 0;                                                                   
        }
        
        top_bit = x &gt;&gt; 25;
        imm32 = top_bit ? (x | (0xFFFFFFFF &lt;&lt; 26)) : x;
        if (type == BLX_ARM) {
            value = pc + imm32 + 1;
        }
        else {
            value = pc + imm32;
        }
        trampoline_instructions[trampoline_pos++] = value;
        
    }
</code></pre>

<ol>
<li>假设原程序实际要跳转到的地址为<code>addr1</code>。</li>
<li>由于BLX,BL指令会在跳转前将下一条指令地址保存到LR寄存器中，因此先用<code>ADD LR, PC, #4</code>把LR寄存器的值保存下来，这个值是本条指令地址+12 bytes处，即存储<code>addr1</code>数据的下一个地址。</li>
<li>用<code>LDR PC, [PC, #-4]</code>将PC指向原本要跳转过去的地址<code>addr1</code>。</li>
<li>将<code>addr1</code>的具体值保存在接下来的4 bytes中。</li>
</ol>

<p>这个<code>addr1</code>的具体值是计算出来的，由于B系列指令使用的是相对地址，因此，需要加上PC的值。</p>

<p>代码中的x的值就是偏移值，它处于指令的后3 bytes，用<code>instruction &amp; 0xFFFFFF</code>即可得到。当它为0时，代表当前PC所指向的地址（ARM32下为本条命令+8 bytes）。每当它增加或减少1，就代表地址增加或减少4 bytes，因此代码中使用<code>&lt;&lt;2</code>对x的值进行*4。</p>

<p>所以这个x也可能是个负数，因此通过取top_bit来判断当前这个偏移的正负，用imm32代表综合考虑了x、正负、thumb标志的偏移值。</p>

<p>BLX指令需要额外关心跳转后thumb-2模式下的地址，由于thumb模式下地址的最小单位是2 bytes，而不是ARM32下的4 bytes，因此需要通过<code>instruction &amp; 0x1000000</code>获得指令第25 bit的标志位，如果标志位为1，地址就需要+2 bytes。</p>

<p>最后，将pc加上imm32就是所需跳转的地址的绝对地址<code>addr1</code>。由于BLX需要切换thumb模式，因此我们用<code>LDR PC, [PC, #-4]</code>来跳转的时候需要<code>addr1</code>额外再+1来切换CPU模式。</p>

<h4 id="add">ADD</h4>

<p>修复代码如下：</p>

<pre><code>    else if (type == ADD_ARM) {
        int rd;
        int rm;
        int r;
        
        rd = (instruction &amp; 0xF000) &gt;&gt; 12;
        rm = instruction &amp; 0xF;
        
        for (r = 12; ; --r) { //找一个既不是rm,也不是rd的寄存器 
            if (r != rd &amp;&amp; r != rm) {
                break;
            }
        }
        
        trampoline_instructions[trampoline_pos++] = 0xE52D0004 | (r &lt;&lt; 12); // PUSH {Rr} 
        trampoline_instructions[trampoline_pos++] = 0xE59F0008 | (r &lt;&lt; 12); // LDR Rr, [PC, #8] 
        trampoline_instructions[trampoline_pos++] = (instruction &amp; 0xFFF0FFFF) | (r &lt;&lt; 16);
        trampoline_instructions[trampoline_pos++] = 0xE49D0004 | (r &lt;&lt; 12); // POP {Rr} 
        trampoline_instructions[trampoline_pos++] = 0xE28FF000; // ADD PC, PC, #0 
        trampoline_instructions[trampoline_pos++] = pc;
    }
</code></pre>

<p>ADD指令可能会涉及到PC，PC就是R15寄存器，用到它的时候它会位于该指令的[16:19]bit上，所以要找个别的寄存器存着原来程序PC的值代替这里的R15即可。</p>

<p>本指令会用到位于指令[12:15]和[0:3]bit上的两个寄存器rd和rm，这两个在修复过程中要避免改变。</p>

<ol>
<li>从前12个寄存器中找一个既不是rd也不是rm的寄存器Rr就行，把它pop到栈上保存当前的值。</li>
<li>用<code>LDR Rr, [PC, #8]</code>把修复代码尾部保存的PC的值赋给Rr。</li>
<li>用<code>(instruction &amp; 0xFFF0FFFF) | (r &lt;&lt; 16);</code>把Rr代替掉原来[16:19]bit上的PC，这样这条ADD执行后就是原本程序中的结果。</li>
<li>Rr的作用已经用完了，那就把它保存在栈上原来的值pop出来恢复它。</li>
<li>用<code>ADD PC, PC, #0</code>来跳过下面尾部的pc数据，去继续执行pc值下方的代码。</li>
<li>用4 bytes保存了原本程序中的pc值。</li>
</ol>

<h4 id="adr-ldr-mov">ADR, LDR, MOV</h4>

<p>修复代码如下：</p>

<pre><code>    else if (type == ADR1_ARM || type == ADR2_ARM || type == LDR_ARM || type == MOV_ARM) {
        int r;
        uint32_t value;
        
        r = (instruction &amp; 0xF000) &gt;&gt; 12;
        
        if (type == ADR1_ARM || type == ADR2_ARM || type == LDR_ARM) {
            uint32_t imm32;
            
            imm32 = instruction &amp; 0xFFF;
            if (type == ADR1_ARM) {
                value = pc + imm32;
            }
            else if (type == ADR2_ARM) {
                value = pc - imm32;
            }
            else if (type == LDR_ARM) {
                int is_add;
                
                is_add = (instruction &amp; 0x800000) &gt;&gt; 23;
                if (is_add) {
                    value = ((uint32_t *) (pc + imm32))[0];
                }
                else {
                    value = ((uint32_t *) (pc - imm32))[0];
                }
            }
        }
        else {
            value = pc;
        }
            
        trampoline_instructions[trampoline_pos++] = 0xE51F0000 | (r &lt;&lt; 12); // LDR Rr, [PC] 
        trampoline_instructions[trampoline_pos++] = 0xE28FF000; // ADD PC, PC 
        trampoline_instructions[trampoline_pos++] = value;
    }
</code></pre>

<ol>
<li>用<code>(instruction &amp; 0xF000) &gt;&gt; 12</code>来获取命令中需要用到的寄存器Rr。</li>
<li>由于这三个指令用的也是相对地址，所以用imm32获取指令[11:0]bit的值后，直接和pc进行加减。由于ADD和LDR涉及偏移的正负性，所以额外寻找各自的标志位来确认是用原pc值加还是减。</li>
<li>用<code>LDR Rr, [PC]</code>将上一步计算得到的value的值赋给Rr。</li>
<li>用<code>ADD PC, PC, #0</code>命令来跳过下方存储的value数据，从value后面的指令开始继续执行。</li>
</ol>

<h4 id="其它指令">其它指令</h4>

<p>ARM32下的其它指令无需修复，直接在备份代码中使用即可。</p>

<h2 id="thumb16">Thumb16</h2>

<h4 id="b-bx">B, BX</h4>

<p>核心修复代码如下：</p>

<pre><code>    trampoline_instructions[idx++] = 0xF8DF;
    trampoline_instructions[idx++] = 0xF000;    // LDR.W PC, [PC] 
    trampoline_instructions[idx++] = value &amp; 0xFFFF;
    trampoline_instructions[idx++] = value &gt;&gt; 16;
</code></pre>

<ol>
<li>计算出要跳转的绝对地址Value</li>
<li>用LDR.W这个Thumb32指令加载后面的Value跳转过去</li>
</ol>

<h4 id="add-1">ADD</h4>

<p>核心修复代码如下：</p>

<pre><code>    rdn = ((instruction &amp; 0x80) &gt;&gt; 4) | (instruction &amp; 0x7);
    
    for (r = 7; ; --r) {
        if (r != rdn) {
            break;
        }
    }
    
    trampoline_instructions[0] = 0xB400 | (1 &lt;&lt; r); // PUSH {Rr} 
    trampoline_instructions[1] = 0x4802 | (r &lt;&lt; 8); // LDR Rr, [PC, #8] 
    trampoline_instructions[2] = (instruction &amp; 0xFF87) | (r &lt;&lt; 3); //我猜是adr Rd, Rr 
    trampoline_instructions[3] = 0xBC00 | (1 &lt;&lt; r); // POP {Rr} 
    trampoline_instructions[4] = 0xE002;    // B PC 
    trampoline_instructions[5] = 0xBF00;
    trampoline_instructions[6] = pc &amp; 0xFFFF;  //计算得到的Value实际值 
    trampoline_instructions[7] = pc &gt;&gt; 16;
</code></pre>

<ol>
<li>ADD_THUMB16命令会用到R0-R7中的某个寄存器Rn作为保存结果的寄存器，于是这个寄存器我们修复时不去影响它，从R0-R7中选择另一个Rr。先用PUSH将Rr原本的值存入栈中。</li>
<li>把计算出来的与原PC相关的Value值存入Rr寄存器。</li>
<li>把Rr代替原来指令ADD Rd, X中的X，从而加给目标寄存器Rd。</li>
<li>POP出Rr原本的值</li>
<li>用B命令进行跳转，从而跨越下方Value的值继续执行。</li>
</ol>

<h4 id="mov-adr-ldr">MOV, ADR, LDR</h4>

<p>核心修复代码如下：</p>

<pre><code>    trampoline_instructions[0] = 0x4800 | (r &lt;&lt; 8); // LDR Rd, [PC] 
    trampoline_instructions[1] = 0xE001;    // B PC, #2 
    trampoline_instructions[2] = value &amp; 0xFFFF;
    trampoline_instructions[3] = value &gt;&gt; 16;
</code></pre>

<p>这三条都是把PC相关的值存入一个寄存器中。因此步骤很明确：</p>

<ol>
<li>用LDR命令把下方隔着2 Bytes的存着实际原本PC相关的值Value存入目标寄存器Rd中即可。</li>
<li>用B命令跳6 Bytes到Value下方继续执行接下去的命令。</li>
</ol>

<h4 id="cbz-cbnz">CBZ, CBNZ</h4>

<p>核心修复代码如下：</p>

<pre><code>    trampoline_instructions[0] = instruction &amp; 0xFD07;
    trampoline_instructions[1] = 0xE003;    // B PC, #6 
    trampoline_instructions[2] = 0xF8DF;
    trampoline_instructions[3] = 0xF000;    // LDR.W PC, [PC] 
    trampoline_instructions[4] = value &amp; 0xFFFF;
    trampoline_instructions[5] = value &gt;&gt; 16;
</code></pre>

<ol>
<li>将原本CBZ/CBNZ的参数清空，清空后参数为4（即PC+4）。例如：<code>CBNZ R0, 10</code>变成<code>CBNZ R0, 4</code>,满足条件时会向下跳4 Bytes；不满足条件时会继续执行下一条指令。</li>
<li>如果不满足CB的条件，则继续执行<code>B PC, #6命令</code>，跨过下面8 Bytes，去执行第10 Byte的指令，即下一条备份指令的修复指令中去。</li>
<li>如果满足条件，会去执行<code>LDR.W PC, [PC]</code>指令，从而根据计算出的Value跳转到原本CB需要跳转去的地方。</li>
</ol>

<h4 id="其它指令-1">其它指令</h4>

<p>Thumb模式下，需要把其它备份的Thumb16指令下方补一个NOP！为什么？因为上文中我们修复的Thumb指令中都是用Thumb32指令LDR.W PC XXX进行跳转的。而<code>Thumb32下涉及修改PC的指令一定要位于可以整除4的地址上</code>。因此，我们需要保证每个Thumb指令都被修复成可以整除4的大小，这样以后修复时只要保证当前LDR.W要在当前正在修复的指令中的偏移可以整除4就行了。</p>

<h2 id="thumb32">Thumb32</h2>

<h4 id="b-bx-blx-bl">B, BX, BLX, BL</h4>

<p>修复代码如下：</p>

<pre><code>    else if (type == BLX_THUMB32 || type == BL_THUMB32 || type == B1_THUMB32 || type == B2_THUMB32) {

        j1 = (low_instruction &amp; 0x2000) &gt;&gt; 13;
        j2 = (low_instruction &amp; 0x800) &gt;&gt; 11;
        s = (high_instruction &amp; 0x400) &gt;&gt; 10;
        i1 = !(j1 ^ s);
        i2 = !(j2 ^ s);

        if (type == BLX_THUMB32 || type == BL_THUMB32) {
            LOGI(&quot;BLX_THUMB32 BL_THUMB32&quot;);
            trampoline_instructions[idx++] = 0xF20F;
            trampoline_instructions[idx++] = 0x0E09;    // ADD.W LR, PC, #9 
        }
        else if (type == B1_THUMB32) {
            LOGI(&quot;B1_THUMB32&quot;);
            trampoline_instructions[idx++] = 0xD000 | ((high_instruction &amp; 0x3C0) &lt;&lt; 2);
            trampoline_instructions[idx++] = 0xE003;    // B PC, #6 
        }
        trampoline_instructions[idx++] = 0xF8DF;
        trampoline_instructions[idx++] = 0xF000;    // LDR.W PC, [PC] 
        if (type == BLX_THUMB32) {
            LOGI(&quot;BLX_THUMB32&quot;);
            x = (s &lt;&lt; 24) | (i1 &lt;&lt; 23) | (i2 &lt;&lt; 22) | ((high_instruction &amp; 0x3FF) &lt;&lt; 12) | ((low_instruction &amp; 0x7FE) &lt;&lt; 1);
            imm32 = s ? (x | (0xFFFFFFFF &lt;&lt; 25)) : x;
            value = pc + imm32;
            LOGI(&quot;blx_thumb32 : value : %x&quot;,value);
        }
        else if (type == BL_THUMB32) {
            LOGI(&quot;BL_THUMB32&quot;);
            x = (s &lt;&lt; 24) | (i1 &lt;&lt; 23) | (i2 &lt;&lt; 22) | ((high_instruction &amp; 0x3FF) &lt;&lt; 12) | ((low_instruction &amp; 0x7FF) &lt;&lt; 1);
            imm32 = s ? (x | (0xFFFFFFFF &lt;&lt; 25)) : x;
            value = pc + imm32 + 1;
        }
        else if (type == B1_THUMB32) {
            LOGI(&quot;B1_THUMB32&quot;);
            x = (s &lt;&lt; 20) | (j2 &lt;&lt; 19) | (j1 &lt;&lt; 18) | ((high_instruction &amp; 0x3F) &lt;&lt; 12) | ((low_instruction &amp; 0x7FF) &lt;&lt; 1);
            imm32 = s ? (x | (0xFFFFFFFF &lt;&lt; 21)) : x;
            value = pc + imm32 + 1;
        }
        else if (type == B2_THUMB32) {
            LOGI(&quot;B2_THUMB32&quot;);
            x = (s &lt;&lt; 24) | (i1 &lt;&lt; 23) | (i2 &lt;&lt; 22) | ((high_instruction &amp; 0x3FF) &lt;&lt; 12) | ((low_instruction &amp; 0x7FF) &lt;&lt; 1);
            imm32 = s ? (x | (0xFFFFFFFF &lt;&lt; 25)) : x;
            value = pc + imm32 + 1;
        }
        trampoline_instructions[idx++] = value &amp; 0xFFFF;
        trampoline_instructions[idx++] = value &gt;&gt; 16;
        offset = idx;
    }
</code></pre>

<p>这段代码比较长哈，我整理了一下(每行代表2 Bytes)：</p>

<pre><code>ADD.W LR, PC, #9（仅BL,BLX）.1
ADD.W LR, PC, #9（仅BL,BLX）.2 或 B PC, #2（仅B1）
LDR.W PC, [PC].1
LDR.W PC, [PC].2
Value.1
Value.2
</code></pre>

<ol>
<li>由于这一类指令都是跳转指令，因此，当然会出现最后四行本项目中大家已经非常熟悉的套路：用LDR.W来加载绝对地址数据进行跳转。我们的插桩也都是这么做的。</li>
<li>如果是BL,BLX指令的话，它俩是要保存返回地址的。于是就用ADD.W对LR寄存器进行操控。那么存进LR的返回地址是什么呢？是PC+9。也就是当前这条ADD.W指令所在地址+4（三级流水的PC领先当前thumb指令4 Bytes）然后+8（下方Value后的距离）的位置。而由于这里是Thumb模式，因此跳转目标执行完毕后需要对地址+1才能以Thumb模式跳转回来。因此是PC+9。</li>
<li>如果是B1的话，那就直接用B加载6个偏移之后，也就是PC+2的Value即可。</li>
<li>最后的Value是它们各自通过相对地址计算出的实际地址，部分为了Thumb模式还最后+1。感兴趣的朋友可以自己细看一下每条指令Value值的具体计算细节。</li>
</ol>

<h4 id="tbb-tbh">TBB, TBH</h4>

<p>修复代码如下：</p>

<pre><code>    trampoline_instructions[0] = 0xB400 | (1 &lt;&lt; rx);    // PUSH {Rx} 
    trampoline_instructions[1] = 0x4805 | (r &lt;&lt; 8); // LDR Rr, [PC, #20] 
    trampoline_instructions[2] = 0x4600 | (rm &lt;&lt; 3) | rx;   // MOV Rx, Rm 
    if (type == TBB_THUMB32) {
        LOGI(&quot;TBB_THUMB32&quot;);
        trampoline_instructions[3] = 0xEB00 | r;
        trampoline_instructions[4] = 0x0000 | (rx &lt;&lt; 8) | rx;   // ADD.W Rx, Rr, Rx 
        trampoline_instructions[5] = 0x7800 | (rx &lt;&lt; 3) | rx;   // LDRB Rx, [Rx] 
    }
    else if (type == TBH_THUMB32) {
         LOGI(&quot;TBH_THUMB32&quot;);
        trampoline_instructions[3] = 0xEB00 | r;
        trampoline_instructions[4] = 0x0040 | (rx &lt;&lt; 8) | rx;   // ADD.W Rx, Rr, Rx, LSL #1 
        trampoline_instructions[5] = 0x8800 | (rx &lt;&lt; 3) | rx;   // LDRH Rx, [Rx] 
    }
    trampoline_instructions[6] = 0xEB00 | r;
    trampoline_instructions[7] = 0x0040 | (r &lt;&lt; 8) | rx;    // ADD Rr, Rr, Rx, LSL #1 
    trampoline_instructions[8] = 0x3001 | (r &lt;&lt; 8); // ADD Rr, #1 
    trampoline_instructions[9] = 0xBC00 | (1 &lt;&lt; rx);    // POP {Rx} 
    trampoline_instructions[10] = 0x4700 | (r &lt;&lt; 3);    // BX Rr 
    trampoline_instructions[11] = 0xBF00;
    trampoline_instructions[12] = pc &amp; 0xFFFF;
    trampoline_instructions[13] = pc &gt;&gt; 16;
</code></pre>

<p>这两条指令是查表跳转指令，类似于switch逻辑。</p>

<ol>
<li>R0-R7中取一个Rx寄存器，它不能是原本命令中已经用到的Rm,Rr寄存器，把它的值PUSH到栈上保存起来。</li>
<li>TBB下，表中偏移计算为：offset=Rm+[原本的PC+4];TBH下则为：offset=2*Rm+[原本的PC+4]。</li>
<li>根据计算出的偏移和原本的PC去取值放入Rr中。</li>
<li>把Rx的值从栈中POP出来。</li>
<li>由于是Thumb模式，于是对Rr+1后再用BX进行跳转。</li>
</ol>

<h4 id="adr-ldr">ADR, LDR</h4>

<p>核心修复代码如下：</p>

<pre><code>    trampoline_instructions[0] = 0x4800 | (r &lt;&lt; 8); // LDR Rd, [PC] 
    trampoline_instructions[1] = 0xE001;    // B PC, #2 
    trampoline_instructions[2] = value &amp; 0xFFFF;
    trampoline_instructions[3] = value &gt;&gt; 16;
</code></pre>

<p>这三条都是把PC相关的值存入一个寄存器中。因此步骤很明确：</p>

<ol>
<li>用LDR命令把下方隔着2 Bytes的存着实际原本PC相关的值Value存入目标寄存器Rd中即可。</li>
<li>用B命令跳6 Bytes到Value下方继续执行接下去的命令。</li>
</ol>

<h4 id="其它指令-2">其它指令</h4>

<p>Thumb32下的其它指令无需修复，直接在备份代码中使用即可。</p>

<h2 id="局限性思考">局限性思考</h2>

<p>本项目虽然尽可能多地考虑了各种指令与情况的修复方案，但是依然如下情况下可能对使用者造成问题。但是本人认为这些问题都是可以通过正确的使用方法来规避的。因此这部分可能更像是个使用指导。以下内容可能比较钻牛角尖，考虑的都是一些脑补的极端情况：</p>

<ol>
<li><code>备份之外的程序其它指令需要跳转到备份指令范围内</code></li>
<li><code>Hook在函数最最最末尾</code></li>
</ol>

<h4 id="局限分析1">局限分析1</h4>

<p>这个情况理论上存在但<code>非常少见</code>且<code>可以避免</code>。因为备份指令的范围其实非常小，Arm下只有2条指令8 Bytes的大小，Thumb-2下也只有10/12 Bytes，对于有成千上万条指令的原程序来说概率非常小！并且这些备份的空间不是都会出问题。</p>

<p><code>概率小</code></p>

<p><code>对于Arm来说</code>：第一个4 Bytes上覆盖的是LDR跳转指令，第二个4 Bytes是地址，因此跳转到第一个LDR指令上是完全没有问题的，就按照Hook流程运行而已，只有正好跳转到第二个地址处才会出现将数据误以为是指令的错误。</p>

<p><code>对于Thumb-2来说</code>：跳转到Hook地址开头可能的Nop或LDR指令也是完全没有问题的，并且12/10Bytes下跳转到最后的4/2 Bytes中也是没有问题的，因为那里并没有被覆盖指令。依然仅仅是直接跳转到那个4 Bytes的地址才出问题。当然Thumb-2模式下可能出现最后的2 Bytes是被截断的Thumb32位的后16位的可能性（它的前16位被跳转地址的后16位覆盖了）。</p>

<p><code>可以避免</code></p>

<p>在使用Hook工具前肯定是会逆向分析的。要避免这种情况最简单的方法就是不要让自己的备份代码“跨代码块”。什么意思？看下图即可理解：</p>

<p>（贴一张有loc小标签的图，别太密集，有一个就行，否则读者会觉得这样的情景很多）</p>

<p>上图中是我们使用IDA等逆向分析工具时的界面，可以看到其中有一个个小标签，这些小标签就是可能被跳转的目标。因此当我们的备份范围没有跨越两个或多个小标签的时候就不会出现其它指令跳转到我们插桩代码中间的跳转地址处的情况了。</p>

<h4 id="使用指导1">使用指导1</h4>

<p>不要“跨代码块”进行Hook。</p>

<h4 id="局限分析2">局限分析2</h4>

<p>这个情况与其说是局限，倒更应当是个使用指导上的说明：有使用者可能会去用本工具Hook某函数的末尾从而希望获取返回值。于是将目标地址对准了那个函数最后的指令上。我个人不建议这么做，而是建议Hook在它的上层调用函数中，也就是调用这个函数后的语句上来获取寄存器R0中的返回值。</p>

<p>如果真的遇到了不得不Hook在函数末尾附近的情况，那这个工具也是完全可以Hook到的：</p>

<p><code>对于Arm32来说</code>：Arm32的函数结尾一般是几条与逻辑无关的恢复寄存器状态的代码，它们在返回值R0计算出来之后执行，因此Hook它们后即可读取返回值R0的内容。如果很不幸，遇到了极为少见的情况：备份的两条里第一条和R0有关，第二条直接跳转返回了，没有恢复寄存器之类的指令，那也就一条和返回值有关的汇编指令而已，输出这条的寄存器状态，然后脑算这条汇编都知道之后的效果。</p>

<p><code>对于Thumb-2来说</code>：同理，可以Hook在函数末尾跳转前的几条指令上就能得到已经计算好的返回值了。极端情况下也只需根据几条指令前的寄存器状态推算一下之后的状态。</p>

<h4 id="使用指导2">使用指导2</h4>

<p>想得到函数的返回值应该去调用它的函数里Hook，而不是在目标函数末尾。实在有特殊情况的话本工具的Hook信息依然可以很轻松推算出返回值。</p>

<blockquote>
<p>本文为转载文章 ，原文出处：<a href="https://gtoad.github.io/2018/07/13/Android-Inline-Hook-Fix/">GToad Blog</a></p>
</blockquote>

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://naivete.cc/tags/hook/">Hook</a>
          <a href="https://naivete.cc/tags/%E6%8C%87%E4%BB%A4%E4%BF%AE%E5%A4%8D/">指令修复</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/%E5%9C%A8android%E7%9A%84%E4%B8%AA%E4%BA%BA%E5%AD%97%E5%85%B8%E4%B8%AD%E5%8F%91%E7%8E%B0%E5%92%8C%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9Ecve-2018-9375/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">在Android的个人字典中发现和利用漏洞(CVE-2018-9375)</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/android-native-hook%E5%B7%A5%E5%85%B7%E5%AE%9E%E8%B7%B5/">
            <span class="next-text nav-default">(转)Android Native Hook工具实践</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:naivetesun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/Vorblock" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/Naivetesun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/274077334" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/6477559" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>
  
    <a href="https://t.me/Vorblock" rel="me noopener" class="iconfont"
      title="telegram"  target="_blank"
      >
      <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1555061894034" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2484" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32"><defs><style type="text/css"></style></defs><path d="M512 16C238 16 16 238 16 512s222 496 496 496 496-222 496-496S786 16 512 16z m243.6 339.8l-81.4 383.6c-6 27.2-22.2 33.8-44.8 21l-124-91.4-59.8 57.6c-6.6 6.6-12.2 12.2-25 12.2l8.8-126.2 229.8-207.6c10-8.8-2.2-13.8-15.4-5l-284 178.8-122.4-38.2c-26.6-8.4-27.2-26.6 5.6-39.4l478.2-184.4c22.2-8 41.6 5.4 34.4 39z" fill="" p-id="2485"></path></svg>
    </a>


<a href="https://naivete.cc/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Vorblock
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
